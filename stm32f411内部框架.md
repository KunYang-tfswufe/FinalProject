### STM32F411xC/xE 微控制器框图描述

本文档提供了对 STM32F411xC/xE 微控制器内部架构的文字描述，内容基于其官方框图（图 3, MSv34920V2）。该架构围绕一个中央总线矩阵构建，连接了 CPU 核心、存储器、DMA 和各类外设总线。

#### 1. 核心与系统组件

- **CPU 核心**:
  - **ARM Cortex-M4 内核**，最高运行频率可达 **100 MHz**。
  - 包含一个**浮点运算单元 (FPU)**。
  - 通过 **I-BUS** (指令总线)、**D-BUS** (数据总线) 和 **S-BUS** (系统总线) 连接到系统。
  - 集成了 **MPU** (内存保护单元) 和 **NVIC** (嵌套向量中断控制器)。

- **存储器**:
  - **512 KB Flash 闪存**，带有加速器/缓存，可实现零等待周期执行。
  - **128 KB SRAM**。

- **调试与追踪**:
  - **JTAG & SWD** (串行线调试) 接口。
  - **ETM** (嵌入式追踪宏单元)。
  - 相关的外部信号包括: `NJTRST, JTDI, JTCK/SWCLK, JTDO/SWD, TRACECLK, TRACED[3:0]`。

- **DMA (直接存储器访问) 控制器**:
  - **DMA1**: 包含 8 个数据流 (Streams) 和一个 FIFO 缓冲器。
  - **DMA2**: 包含 8 个数据流 (Streams) 和一个 FIFO 缓冲器。
  - 两个控制器都连接到 AHB 总线矩阵，实现了外设和存储器之间的高速数据传输，无需 CPU 干预。

#### 2. 系统控制、时钟与电源

- **复位与时钟控制**:
  - 管理系统时钟 (如 `HCLK`, `APB1CLK`, `APB2CLK` 等)。
  - 时钟源包括:
    - **XTAL OSC**: 高速外部晶体振荡器 (4-16 MHz)，信号为 `OSC_IN` 和 `OSC_OUT`。
    - **RC HS/LS**: 内部高速和低速 RC 振荡器。
    - **PLL1&2**: 锁相环 (Phase-Locked Loops)，用于生成高速系统时钟。

- **电源管理**:
  - **VDD**: 主供电范围为 1.7V 至 3.6V (PDR 关闭时) 或 1.8V 至 3.6V (PDR 开启时)。
  - **内部电压调节器**: 从主 3.3V 电源为内核提供 1.2V 电压。
  - **供电监控**: 包括 POR/PDR (上电/掉电复位)、BOR (欠压复位) 和 PVD (可编程电压检测器)。
  - **VBAT**: 电池备份供电 (1.65V 至 3.6V)，用于 RTC 和备份域。

- **RTC (实时时钟) 与备份域**:
  - 由 `VBAT` 供电。
  - 使用外部 **32 kHz 晶体振荡器** (信号为 `OSC32_IN`, `OSC32_OUT`)。
  - 包含 **AWU** (自动唤醒单元) 和备份寄存器。
  - 提供 `ALARM_OUT` 和 `STAMP1` 信号。

- **看门狗 (Watchdogs)**:
  - **WDG 32K**: 独立看门狗 (IWDG)，由其自身的 32 kHz 内部振荡器提供时钟。
  - **WWDT**: 窗口看门狗 (WWDG)，位于 APB1 总线上。

- **CRC 校验单元**:
  - 连接到 AHB1 总线的硬件 CRC 模块。

---

#### 3. 总线与外设

外设通过一个多层总线架构连接到核心和 DMA。

##### **AHB2 总线 (100 MHz)**

- **USB OTG FS (On-The-Go 全速)**:
  - 集成了 **PHY** (物理层) 和 FIFO 缓冲器。
  - 外部信号: `DP`, `DM`, `ID`, `VBUS`, `SOF`。

##### **AHB1 总线 (100 MHz)**

- **GPIO 端口**:
  - `GPIO PORT A` (PA[15:0])
  - `GPIO PORT B` (PB[15:0])
  - `GPIO PORT C` (PC[15:0])
  - `GPIO PORT D` (PD[15:0])
  - `GPIO PORT E` (PE[15:0])
  - `GPIO PORT H` (PH[1:0])
- **CRC 校验单元**

##### **APB2 总线 (最高 100 MHz)**

_高速外设_

- **TIM1 / TIM9 / TIM10 / TIM11** (定时器):
  - `TIM1`: 16位高级控制定时器，拥有 4 个通道、3 个互补通道 (`CH1N-CH3N`)、`ETR` 和 `BKIN` 功能。
  - `TIM9`: 16位通用定时器，拥有 2 个通道。
  - `TIM10`, `TIM11`: 16位通用定时器，各拥有 1 个通道。
- **USART1 / USART6** (通用同步/异步收发器):
  - 支持 `smcard` (智能卡) 和 `IrDA` (红外) 模式。
  - 信号 (作为复用功能 AF): `RX, TX, CK, CTS, RTS`。
- **ADC1** (模数转换器):
  - 提供多达 **16 个模拟输入**通道。
  - 包含一个内部**温度传感器**。
  - 参考电压输入: `VDDREF_ADC`，由 `VDDA` 供电。
- **SPI1 / SPI4 / SPI5** (串行外设接口):
  - 也可配置为 **I2S1 / I2S4 / I2S5** (集成电路内置音频总线)。
  - 信号 (作为 AF): `MOSI/SD`, `MISO/SD_ext`, `SCK/CK`, `NSS/WS`。
- **SDIO / MMC**:
  - SD/SDIO/MMC 卡接口，带有 FIFO 缓冲器。
  - 信号 (作为 AF): `D[7:0]`, `CMD`, `CK`。
- **EXTI**:
  - 外部中断和事件控制器，具备唤醒功能。支持最多 81 个映射到 GPIO 的复用功能。

##### **APB1 总线 (最高 50 MHz)**

_低速外设_

- **TIM2 / TIM3 / TIM4 / TIM5** (定时器):
  - `TIM2`, `TIM5`: 32位通用定时器，拥有 4 个通道 (`TIM2` 支持 `ETR`)。
  - `TIM3`, `TIM4`: 16位通用定时器，拥有 4 个通道并支持 `ETR`。
- **USART2**:
  - 支持 `smcard` 和 `IrDA` 模式。
  - 信号 (作为 AF): `RX, TX, CTS, RTS`。
- **SPI2 / SPI3**:
  - 也可配置为 **I2S2 / I2S3**。
  - 信号 (作为 AF): `MOSI/SD`, `MISO/SD_ext`, `SCK/CK`, `NSS/WS`, `MCK`。
- **I2C1 / I2C2 / I2C3** (集成电路互联总线):
  - 同时支持 **SMBUS** 协议。
  - 信号 (作为 AF): `SCL, SDA, SMBA`。
- **WWDT** (窗口看门狗)。
- **电源接口 (PWR)** (属于系统模块，但通过 APB1 总线控制)。

---

#### 4. 图表脚注

1.  连接到 **APB2** 总线的定时器，其时钟源 (TIMxCLK) 频率最高可达 **100 MHz**。
2.  连接到 **APB1** 总线的定时器，其时钟源 (TIMxCLK) 频率最高可达 **50 MHz**。
